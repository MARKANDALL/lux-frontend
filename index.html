<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lux Pronunciation Tool</title>

    <link rel="stylesheet" href="base.css" />
    <link rel="stylesheet" href="features-1.css" />
    <link rel="stylesheet" href="features-2.css" />
    <link rel="stylesheet" href="lux-popover.css" />
    <link rel="stylesheet" href="lux-onboarding.css" />
    <link rel="stylesheet" href="lux-main.css" />

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="./features/features/tts.css" />
    <link rel="stylesheet" href="./features/features/tts-peekaboo.css" />
    <link rel="stylesheet" href="./features/features/tts/tts-overlay.css" />
    <link rel="stylesheet" href="./features/features/self-playback.css" />
    <link rel="stylesheet" href="./features/features/selfpb-peekaboo.css" />

    <style id="lux-tts-guard-style">
      #tts-controls { display: none !important; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/7.8.11/wavesurfer.min.js"></script>

    <script type="importmap">
      {
        "imports": {
          "ai.js": "./api/ai.js",
          "./api.js": "./api/index.js"
        }
      }
    </script>

    <script src="lux-popover.js" defer></script>
  </head>
  <body>
    <div id="container">
      <h2>Pronunciation Test</h2>

      <div id="userMsg">
        <ol>
          <li>We use and measure for standard American accents. Hear what it should sound like:</li>
          <li>The more recordings you make, the better the feedback will be ğŸ¤” ğŸ’­ ğŸ’¡ ğŸ˜®:
            <span class="lux-cta" tabindex="0" aria-haspopup="dialog" aria-expanded="false">
              database tracking
              <span class="lux-pop" role="dialog" aria-label="Database tracking details">
                <strong style="display: block; margin-bottom: 6px">How tracking helps</strong>
                <p style="margin: 0 0 8px; color: #444; font-size: 13px">
                  We save summaries of your practice so feedback improves over time.
                </p>
                <div class="lux-uidrow">
                  <span>Your UID:</span>
                  <code id="lux-uid">â€¦</code>
                  <button id="lux-copy" class="lux-btn" type="button">Copy</button>
                  <small id="lux-copied" class="lux-copied" aria-live="polite"></small>
                </div>
                <div class="lux-links">
                  <a id="lux-link-attempts" target="_blank" rel="noopener">Attempts (admin)</a>
                  <a id="lux-link-progress" target="_blank" rel="noopener">User Progress (admin)</a>
                  <a id="lux-link-cohort" target="_blank" rel="noopener">Cohort (admin)</a>
                </div>
                <small class="lux-note">Admin token required for those pages.</small>
              </span>
            </span>.
          </li>
          <li>Rememberâ€”mistakes are a necessary part of learning! :)</li>
        </ol>
      </div>

      <label>
        Select Passage:
        <select id="passageSelect">
          <option value="" disabled selected>Select Passage...</option>
          <option value="rainbow">Rainbow Passage</option>
          <option value="grandfather">Grandfather Passage</option>
          <option value="minLR">Phoneme Test: L vs R</option>
          <option value="minEEIH">Phoneme Test: EE vs IH</option>
          <option value="minAUAH">Phoneme Test: A vs U</option>
          <option value="wordList">Challenging Word List</option>
          <option value="sentences">Challenging Sentences</option>
          <option value="shortStory">Short Story Practice</option>
          <option disabled>-------------------</option>
          <option value="write-own">Write Your Own...</option>
          <option value="clear">Clear Text</option>
        </select>
        <span id="partsInfoTip" class="tooltip hidden" style="margin-left: 10px; cursor: pointer"> (?) <span class="tooltiptext">These texts are designed to cover most sounds in English.</span></span>
      </label>

      <label style="display: block; margin-top: 14px">
        First language:
        <select id="l1Select" name="l1Select">
          <option value="universal" selected>Universal (English-only)</option>
          <option value="ar">Arabic â€“ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="zh">Chinese â€“ ä¸­æ–‡</option>
          <option value="fr">French â€“ FranÃ§ais</option>
          <option value="de">German â€“ Deutsch</option>
          <option value="hi">Hindi â€“ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
          <option value="ja">Japanese â€“ æ—¥æœ¬èª</option>
          <option value="ko">Korean â€“ í•œêµ­ì–´</option>
          <option value="mr">Marathi â€“ à¤®à¤°à¤¾à¤ à¥€</option>
          <option value="pt">Portuguese â€“ PortuguÃªs</option>
          <option value="ru">Russian â€“ Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
          <option value="es">Spanish â€“ EspaÃ±ol</option>
        </select>
      </label>

      <span id="suggestedSentence" style="display: none"></span>
      <label style="margin-top: 20px">
        <span id="typewriterMsg" style="display: block; margin-bottom: 0.7em"></span>
        <textarea id="referenceText" placeholder="Paste or type everything youâ€™ll read here." rows="3"></textarea>
      </label>

      <div id="ghostControls">
        <button id="nextPartBtn">Next Part</button>
        <span id="nextPartMsg"></span>
        <button id="showSummaryBtn">Show Summary</button>
        <span id="passageLabel"></span>
        <span id="partProgress"></span>
      </div>

      <div class="btn-group">
        <button id="record">Record</button>
        <button id="stop" disabled>Stop</button>
      </div>

      <button id="playbackBtn" style="display: none">â–¶ Play</button>
      <audio id="playbackAudio" hidden></audio>

      <p id="status">Not recording</p>
      <div id="prettyResult"></div>
      <div id="aiFeedbackSection"><div id="aiFeedback"></div></div>
      <button id="showMoreBtn" style="display: none; margin: 1em auto; padding: 0.7em 1.3em; font-size: 1em;">Show More</button>
      <div><span class="show-raw-link" id="toggleRaw">Show Raw Data</span><pre id="rawData" class="raw-data-section"></pre></div>
      
      <div id="ygPreview">
        <video id="ygDemo" src="https://video.wixstatic.com/video/0d5d6f_5ae77fc4972248b38eb63ea25e5068fb/720p/mp4/file.mp4" style="width: 100%; height: 100%; display: block; object-fit: cover" muted playsinline loop autoplay></video>
        <div id="unmuteTip" style="display:none;">ğŸ”Š Click to unmute</div>
      </div>
      
      <div id="phPreview">
        <video id="phDemo" src="https://video.wixstatic.com/video/0d5d6f_e100780f16524e51bd9c8e49f1c8c71c/480p/mp4/file.mp4" style="width: 100%; height: 100%; display: block; object-fit: contain; background: #000;" muted playsinline loop preload="metadata"></video>
        <div id="phUnmuteTip" style="display:none;">ğŸ”Š Click to toggle audio</div>
      </div>
    </div>

    <div id="tts-controls" data-luxHidden="1"></div>

    <script type="module" src="./src/main.js"></script>

    <script type="module">
      import { bootTTS } from './features/features/tts/boot-tts.js';
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bootTTS);
      else bootTTS();
    </script>

    <script type="module">
      import { mountSelfPlaybackLite } from "./features/features/selfpb/ui.js";
      mountSelfPlaybackLite();

      // Hydration logic for Self-Playback audio
      const audioEl = document.getElementById("playbackAudio");
      async function hydrate() {
        if (!audioEl) return;
        const src = audioEl.currentSrc || audioEl.src || audioEl.querySelector("source")?.src;
        if (!src) return;
      }
      audioEl?.addEventListener("loadeddata", hydrate);
      if (audioEl?.src) hydrate();
    </script>

    <script type="module" src="./features/features/08-selfpb-peekaboo.js"></script>
    <script>window.typeWriter = window.typeWriter || function () {};</script>
  </body>
</html>