<!-- index.html (Pronunciation Test) -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lux Pronunciation Tool</title>

    <link rel="stylesheet" href="lux-layout.css" />
    <link rel="stylesheet" href="lux-onboarding.css" />
    <link rel="stylesheet" href="lux-popover.css" />

    <link rel="stylesheet" href="lux-widgets.css" />
    <link rel="stylesheet" href="lux-results.css" />
    <link rel="stylesheet" href="lux-progress.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="./features/features/tts-peekaboo.css" />
    <link rel="stylesheet" href="./features/features/tts/tts-overlay.css" />
    <link rel="stylesheet" href="./features/features/tts.css" />

    <link rel="stylesheet" href="./features/features/selfpb-peekaboo.css" />
    <link rel="stylesheet" href="./features/features/self-playback.css" />
    <link rel="stylesheet" href="./ui/ui-arrow-trail.css" />
    <link rel="stylesheet" href="./ui/warp.css" />

    <style id="lux-tts-guard-style">
      #tts-controls {
        display: none !important;
      }
    </style>

    <script src="./vendor/wavesurfer-7.8.11.min.js"></script>

    <script type="importmap">
      {
        "imports": {
          "ai.js": "./api/ai.js",
          "./api.js": "/src/api/index.js"
        }
      }
    </script>

    <script src="lux-popover.js" defer></script>
  </head>
  <body>
    <!-- Top-of-viewport Tips Banner (fixed; tab remains clickable when collapsed) -->
    <div id="lux-top-banner" class="lux-top-banner" aria-label="Tips banner">
      <!-- This panel slides in/out -->
      <div class="lux-top-banner-panel">
        <div class="lux-top-banner-inner">
          <div id="userMsg" aria-live="polite">
            <ol>
              <li>
                We use and measure for standard American accents. Hear what it should sound like:
                <span class="lux-arrow-trail" data-arrow-trail="tts" aria-hidden="true"></span>
              </li>
              <li>
                The more recordings you make, the better the feedback will be ğŸ¤” ğŸ’­ ğŸ’¡ ğŸ˜®:
                <span class="lux-cta" tabindex="0" aria-haspopup="dialog" aria-expanded="false">
                  database tracking
                  <span class="lux-pop" role="dialog" aria-label="Database tracking details">
                    <strong style="display: block; margin-bottom: 6px">How tracking helps</strong>
                    <p style="margin: 0 0 8px; color: #444; font-size: 13px">
                      We save summaries of your practice so feedback improves over time.
                    </p>
                    <div class="lux-uidrow">
                      <span>Your UID:</span>
                      <code id="lux-uid">â€¦</code>
                      <button id="lux-copy" class="lux-btn" type="button">Copy</button>
                      <small id="lux-copied" class="lux-copied" aria-live="polite"></small>
                    </div>
                    <div class="lux-links">
                      <a id="lux-link-attempts" target="_blank" rel="noopener">Attempts (admin)</a>
                      <a id="lux-link-progress" target="_blank" rel="noopener">User Progress (admin)</a>
                      <a id="lux-link-cohort" target="_blank" rel="noopener">Cohort (admin)</a>
                    </div>
                    <small class="lux-note">Admin token required for those pages.</small>
                  </span>
                </span>.
              </li>
              <li>Rememberâ€”mistakes are a necessary part of learning! :)</li>
            </ol>
          </div>
        </div>
      </div>

      <!-- This tab stays visible when collapsed -->
      <button type="button" class="lux-banner-handle" aria-label="Hide tips" title="Hide tips">
        <span class="lux-banner-label">Tips</span>
        <svg class="lux-banner-caret" viewBox="0 0 20 20" aria-hidden="true" focusable="false">
          <path
            d="M6 12l4-4 4 4"
            fill="none"
            stroke="currentColor"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>
    </div>

    <div id="container">
      <h2>Pronunciation Test</h2>

      <div class="lux-toplinks lux-toplinks-cta">
        <a class="lux-toplink lux-toplink-cta lux-cta-same" href="./convo.html">AI Conversations</a>
      </div>

      <label>
        Select Passage:
        <select id="passageSelect" data-lux-browse-lessons>
          <option value="" disabled selected>Select Passage...</option>

          <!-- Standard Passages -->
          <option value="rainbow">Rainbow Passage</option>
          <option value="grandfather">Grandfather Passage</option>
          <option value="caterpillar">The Caterpillar</option>
          <option value="hunterScript">The Hunter Script</option>
          <option value="huntersStory">The Hunterâ€™s Story</option>

          <option value="arthurTheRat_p1">Arthur the Rat (Part 1)</option>
          <option value="arthurTheRat_p2">Arthur the Rat (Part 2)</option>
          <option value="arthurTheRat_p3">Arthur the Rat (Part 3)</option>

          <option value="johnPassage">The John Passage</option>

          <option value="commaGetsACure_p1">Comma Gets a Cure (Part 1)</option>
          <option value="commaGetsACure_p2">Comma Gets a Cure (Part 2)</option>
          <option value="commaGetsACure_p3">Comma Gets a Cure (Part 3)</option>
          <option value="commaGetsACure_p4">Comma Gets a Cure (Part 4)</option>

          <option value="northWindAndSun">The North Wind and the Sun</option>
          <option value="bamboo">The Bamboo Passage</option>

          <option disabled>-------------------</option>

          <!-- Tests / Drills -->
          <option value="minLR">Phoneme Test: L vs R</option>
          <option value="minEEIH">Phoneme Test: EE vs IH</option>
          <option value="minAUAH">Phoneme Test: A vs U</option>
          <option value="wordList">Challenging Word List</option>
          <option value="sentences">Challenging Sentences</option>
          <option value="shortStory">Short Story Practice</option>

          <option disabled>-------------------</option>

          <option value="write-own">Write Your Own...</option>
          <option value="clear">Clear Text</option>
        </select>

        <span
          id="partsInfoTip"
          class="tooltip"
          style="margin-left: 10px; cursor: pointer; display: inline-block !important;"
        >
          (?)
          <span class="tooltiptext">These texts are designed to cover most sounds in English.</span>
        </span>
      </label>

      <!-- Harvard list picker (next to / below the main passage select) -->
      <div class="lux-harvard-picker" aria-label="Harvard sentence list picker">
        <span class="lux-harvard-label">Harvard</span>

        <button id="harvardPrev" type="button">â—€</button>

        <label class="sr-only" for="harvardNum">Harvard list number</label>
        <input id="harvardNum" type="number" min="1" max="72" step="1" value="1" />

        <button id="harvardNext" type="button">â–¶</button>
        <button id="harvardLoad" type="button">Load</button>
        <button id="harvardRandom" type="button">ğŸ²</button>

        <span id="harvardLoaded" style="margin-left:10px; font-size: 13px; opacity: 0.75;"></span>
      </div>

      <label style="display: block; margin-top: 14px">
        First language:
        <select id="l1Select" name="l1Select">
          <option value="universal" selected>Universal (English-only)</option>
          <option value="ar">Arabic â€“ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="zh">Chinese â€“ ä¸­æ–‡</option>
          <option value="fr">French â€“ FranÃ§ais</option>
          <option value="de">German â€“ Deutsch</option>
          <option value="hi">Hindi â€“ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
          <option value="ja">Japanese â€“ æ—¥æœ¬èª</option>
          <option value="ko">Korean â€“ í•œêµ­ì–´</option>
          <option value="mr">Marathi â€“ à¤®à¤°à¤¾à¤ à¥€</option>
          <option value="pt">Portuguese â€“ PortuguÃªs</option>
          <option value="ru">Russian â€“ Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
          <option value="es">Spanish â€“ EspaÃ±ol</option>
        </select>
      </label>

      <span id="suggestedSentence" style="display: none"></span>

      <label style="margin-top: 20px">
        <span id="typewriterMsg" style="display: block; margin-bottom: 0.7em"></span>
        <textarea id="referenceText" placeholder="Paste or type everything youâ€™ll read here." rows="3"></textarea>
      </label>

      <div id="ghostControls">
        <button id="nextPartBtn">Next Part</button>
        <span id="nextPartMsg"></span>
        <button id="showSummaryBtn">Show Summary</button>
        <span id="passageLabel"></span>
        <span id="partProgress"></span>
      </div>

      <div class="btn-group">
        <button id="record" data-lux-record>Record</button>
        <button id="stop" disabled>Stop</button>
      </div>

      <button id="playbackBtn" style="display: none">â–¶ Play</button>
      <audio id="playbackAudio" hidden></audio>

      <p id="status">Not recording</p>
      <div id="prettyResult"></div>

      <div id="aiFeedbackSection"><div id="aiFeedback"></div></div>
      <button id="showMoreBtn" style="display: none; margin: 1em auto; padding: 0.7em 1.3em; font-size: 1em;">
        Show More
      </button>

      <!-- My Progress (mount target) -->
      <div id="dashboard-root"></div>

      <div id="ygPreview">
        <video
          id="ygDemo"
          src="https://video.wixstatic.com/video/0d5d6f_5ae77fc4972248b38eb63ea25e5068fb/720p/mp4/file.mp4"
          style="width: 100%; height: 100%; display: block; object-fit: cover"
          muted
          playsinline
          loop
          autoplay
        ></video>
        <div id="unmuteTip" style="display:none;">ğŸ”Š Click to unmute</div>
      </div>

      <div id="phPreview">
        <video
          id="phDemo"
          src="https://video.wixstatic.com/video/0d5d6f_e100780f16524e51bd9c8e49f1c8c71c/480p/mp4/file.mp4"
          style="width: 100%; height: 100%; display: block; object-fit: contain; background: #000;"
          muted
          playsinline
          loop
          preload="metadata"
        ></video>
        <div id="phUnmuteTip" style="display:none;">ğŸ”Š Click to toggle audio</div>
      </div>
    </div>

    <div id="tts-controls" data-luxHidden="1"></div>

    <script type="module" src="./src/main.js"></script>

    <script type="module">
      import { bootTTS } from './features/features/tts/boot-tts.js';
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bootTTS);
      else bootTTS();
    </script>

    <script>
      window.typeWriter = window.typeWriter || function () {};
    </script>

    <!-- Lux FX: â€œCorona flareâ€ for the AI Conversations halo (Edge-safe: use url(#filter) ONLY in CSS) -->
    <svg
      class="lux-fx"
      width="0"
      height="0"
      aria-hidden="true"
      focusable="false"
      style="position:absolute; width:0; height:0; overflow:hidden"
    >
      <filter id="luxCoronaFlare" x="-70%" y="-70%" width="240%" height="240%" color-interpolation-filters="sRGB">
        <!-- Base â€œslow driftâ€ noise -->
        <feTurbulence type="fractalNoise" baseFrequency="0.010" numOctaves="2" seed="9" result="n1">
          <animate attributeName="baseFrequency" dur="8.0s" values="0.008;0.014;0.010" repeatCount="indefinite" />
        </feTurbulence>

        <!-- Faster flicker noise (drives flare patches) -->
        <feTurbulence type="turbulence" baseFrequency="0.040" numOctaves="1" seed="4" result="n2">
          <animate attributeName="baseFrequency" dur="1.35s" values="0.028;0.055;0.034" repeatCount="indefinite" />
        </feTurbulence>

        <feComposite in="n1" in2="n2" operator="arithmetic" k1="0" k2="0.78" k3="0.38" k4="0" result="noise" />

        <!-- Thicken the ring a bit -->
        <feMorphology in="SourceGraphic" operator="dilate" radius="2.8" result="fat" />

        <!-- Extract just the outer rim so flares feel like they come from the edge -->
        <feMorphology in="fat" operator="erode" radius="4.4" result="inner" />
        <feComposite in="fat" in2="inner" operator="out" result="rim" />

        <!-- Turn noise into an alpha â€œflare maskâ€ with high contrast (patchy, not uniform) -->
        <feColorMatrix in="noise" type="luminanceToAlpha" result="noiseA" />
        <feComponentTransfer in="noiseA" result="flareMask">
          <!-- table values = threshold-ish; tweak middle to change how â€œspottyâ€ it is -->
          <feFuncA type="table" tableValues="0 0 0 0.05 0.18 0.75 1 1" />
        </feComponentTransfer>

        <!-- Keep only rim segments selected by the flare mask -->
        <feComposite in="rim" in2="flareMask" operator="in" result="flareRim" />

        <!-- Throw those segments outward with stronger displacement -->
        <feDisplacementMap
          in="flareRim"
          in2="noise"
          scale="62"
          xChannelSelector="R"
          yChannelSelector="G"
          result="flareDisp"
        >
          <animate attributeName="scale" dur="1.55s" values="32;72;38;66;34" repeatCount="indefinite" />
        </feDisplacementMap>

        <!-- Base wobble for the whole halo (subtler than the flares) -->
        <feDisplacementMap in="fat" in2="noise" scale="22" xChannelSelector="R" yChannelSelector="G" result="baseDisp">
          <animate attributeName="scale" dur="2.6s" values="14;28;18;24;16" repeatCount="indefinite" />
        </feDisplacementMap>

        <!-- Bloom layers -->
        <feGaussianBlur in="baseDisp" stdDeviation="10.5" result="baseGlow" />
        <feGaussianBlur in="flareDisp" stdDeviation="16.0" result="flareGlow">
          <animate attributeName="stdDeviation" dur="1.6s" values="12;19;13;18;12" repeatCount="indefinite" />
        </feGaussianBlur>

        <feMerge result="merged">
          <feMergeNode in="baseGlow" />
          <feMergeNode in="flareGlow" />
        </feMerge>

        <!-- Punch: saturation + alpha lift -->
        <feColorMatrix in="merged" type="saturate" values="1.75" result="sat" />
        <feColorMatrix
          in="sat"
          type="matrix"
          values="1 0 0 0 0
                  0 1 0 0 0
                  0 0 1 0 0
                  0 0 0 1.85 -0.24"
          result="out"
        />

        <feMerge>
          <feMergeNode in="out" />
          <feMergeNode in="sat" />
        </feMerge>
      </filter>
    </svg>

    <!-- Warp nav JS (near end of body) -->
    <script type="module" src="./ui/warp-nav.js"></script>
  </body>
</html>
