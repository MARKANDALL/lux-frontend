<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="base.css" />
    <link rel="stylesheet" href="features-1.css" />
    <link rel="stylesheet" href="features-2.css" />
    <link rel="stylesheet" href="lux-popover.css" />
    
    <link rel="stylesheet" href="lux-onboarding.css" />
    <link rel="stylesheet" href="lux-main.css" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="./features/features/tts.css" />
    <link rel="stylesheet" href="./features/features/tts-peekaboo.css" />

    <link rel="stylesheet" href="./features/features/self-playback.css" />
    <link rel="stylesheet" href="./features/features/selfpb-peekaboo.css" />

    <style id="lux-tts-guard-style">
      #tts-controls {
        display: none !important;
      }
    </style>

<style>
      :root {
        --lux-tts-panel-w: 360px;
        --lux-tts-panel-max-w: min(92vw, 380px);
        --lux-tts-panel-max-h: min(520px, 70vh);
        --lux-tts-radius: 14px;
      }
      .lux-tts-panel {
        position: fixed;
        inset: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) auto
          auto;
        z-index: 9999;
        width: var(--lux-tts-panel-w);
        max-width: var(--lux-tts-panel-max-w);
        height: auto;
        max-height: var(--lux-tts-panel-max-h);
        background: #fff;
        border-left: 1px solid rgba(0, 0, 0, 0.06);
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        border-bottom-left-radius: var(--lux-tts-radius);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
        
        /* UPDATED: 100px ensures the tab + part of the white box is visible */
        transform: translateX(calc(100% - 100px));
        
        transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
        display: inline-block;
        overflow: visible;
      }
      
      /* UPDATED: -20px gives breathing room from the scrollbar when open */
      html.lux-tts-open .lux-tts-panel {
        transform: translateX(-20px);
      }
      
      .lux-tts-panel #tts-controls {
        padding: 14px 16px 16px;
        height: auto;
        max-height: none;
        overflow: visible;
        box-sizing: border-box;
      }
      .lux-tts-tab {
        position: absolute;
        left: -128px;
        top: 18px;
        padding: 10px 16px;
        border-radius: 999px 0 0 999px;
        font: 600 16px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: #1082ff;
        color: #fff;
        border: 0;
        cursor: pointer;
        box-shadow: 0 6px 18px rgba(16, 130, 255, 0.28);
        transition: transform 0.18s ease, filter 0.18s ease,
          box-shadow 0.18s ease;
      }
      .lux-tts-tab:hover {
        filter: brightness(1.02);
        transform: translateX(-2px);
      }
      .lux-tts-loading {
        font: 600 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto,
          sans-serif;
        opacity: 0.75;
        padding: 12px 10px;
      }
      @media (max-width: 480px) {
        :root {
          --lux-tts-panel-w: 92vw;
          --lux-tts-panel-max-w: 92vw;
          --lux-tts-panel-max-h: min(82vh, 640px);
        }
      }
    </style>

    <script type="importmap">
      {
        "imports": {
          "ai.js": "./api/ai.js",
          "./api.js": "./api/index.js"
        }
      }
    </script>

    <script src="lux-popover.js" defer></script>
  </head>
  <body>
    <div id="container">
      <h2>Pronunciation Test</h2>

      <div id="userMsg">
        <ol>
          <li>
            We use and measure for standard American accents. Hear what it
            should sound like:
          </li>
          <li>
            The more recordings you make, the better the feedback will be ü§î üí≠
            üí° üòÆ:
            <span
              class="lux-cta"
              tabindex="0"
              aria-haspopup="dialog"
              aria-expanded="false"
            >
              database tracking
              <span
                class="lux-pop"
                role="dialog"
                aria-label="Database tracking details"
              >
                <strong style="display: block; margin-bottom: 6px"
                  >How tracking helps</strong
                >
                <p style="margin: 0 0 8px; color: #444; font-size: 13px">
                  We save summaries of your practice so feedback improves over
                  time.
                </p>

                <div class="lux-uidrow">
                  <span>Your UID:</span>
                  <code id="lux-uid">‚Ä¶</code>
                  <button id="lux-copy" class="lux-btn" type="button">
                    Copy
                  </button>
                  <small
                    id="lux-copied"
                    class="lux-copied"
                    aria-live="polite"
                  ></small>
                </div>

                <div class="lux-links">
                  <a id="lux-link-attempts" target="_blank" rel="noopener"
                    >Attempts (admin)</a
                  >
                  <a id="lux-link-progress" target="_blank" rel="noopener"
                    >User Progress (admin)</a
                  >
                  <a id="lux-link-cohort" target="_blank" rel="noopener"
                    >Cohort (admin)</a
                  >
                </div>

                <small class="lux-note"
                  >Admin token required for those pages.</small
                >
              </span> </span
            >.
          </li>
          <li>Remember‚Äîmistakes are a necessary part of learning! :)</li>
        </ol>
      </div>

      <label>
        Select Passage:
        <select id="passageSelect">
          <option value="rainbow">Rainbow Passage</option>
          <option value="grandfather">Grandfather Passage</option>
          <option value="minLR">Phoneme Test: L vs R</option>
          <option value="minEEIH">Phoneme Test: EE vs IH</option>
          <option value="minAUAH">Phoneme Test: A vs U</option>
          <option value="wordList">Challenging Word List</option>
          <option value="sentences">Challenging Sentences</option>
          <option value="shortStory">Short Story Practice</option>
        </select>
        <span
          id="partsInfoTip"
          class="tooltip hidden"
          style="margin-left: 10px; cursor: pointer"
        >
          (?)
          <span class="tooltiptext" style="font-size: 1em">
            These texts are designed to cover most sounds in English. Practicing
            them helps reveal your pronunciation strengths and weaknesses.
          </span>
        </span>
      </label>

      <label style="display: block; margin-top: 14px">
        First language:
        <select id="l1Select" name="l1Select">
          <option value="universal" selected>Universal (English-only)</option>
          <option value="ar">Arabic ‚Äì ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="zh">Chinese ‚Äì ‰∏≠Êñá</option>
          <option value="fr">French ‚Äì Fran√ßais</option>
          <option value="de">German ‚Äì Deutsch</option>
          <option value="hi">Hindi ‚Äì ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
          <option value="ja">Japanese ‚Äì Êó•Êú¨Ë™û</option>
          <option value="ko">Korean ‚Äì ÌïúÍµ≠Ïñ¥</option>
          <option value="mr">Marathi ‚Äì ‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
          <option value="pt">Portuguese ‚Äì Portugu√™s</option>
          <option value="ru">Russian ‚Äì –†—É—Å—Å–∫–∏–π</option>
          <option value="es">Spanish ‚Äì Espa√±ol</option>
        </select>
      </label>

      <span id="suggestedSentence" style="display: none"></span>
      <label style="margin-top: 20px">
        <span
          id="typewriterMsg"
          style="display: block; margin-bottom: 0.7em"
        ></span>
        <textarea
          id="referenceText"
          placeholder="Paste or type everything you‚Äôll read here."
          rows="3"
        ></textarea>
      </label>

      <div id="ghostControls">
        <button id="nextPartBtn">Next Part</button>
        <span id="nextPartMsg"></span>
        <button id="showSummaryBtn">Show Summary</button>
        <span id="passageLabel"></span>
        <span id="partProgress"></span>
      </div>

      <div class="btn-group">
        <button id="record">Record</button>
        <button id="stop" disabled>Stop</button>
      </div>

      <button id="playbackBtn" style="display: none">‚ñ∂ Play</button>
      <audio id="playbackAudio" hidden></audio>

      <p id="status">Not recording</p>
      <div id="prettyResult"></div>
      <div id="aiFeedbackSection"><div id="aiFeedback"></div></div>

      <button
        id="showMoreBtn"
        style="
          display: none;
          margin: 1em auto;
          padding: 0.7em 1.3em;
          font-size: 1em;
        "
      >
        Show More
      </button>

      <div>
        <span class="show-raw-link" id="toggleRaw">Show Raw Data</span>
        <pre id="rawData" class="raw-data-section"></pre>
      </div>

      <div id="ygPreview">
        <video
          id="ygDemo"
          src="https://video.wixstatic.com/video/0d5d6f_5ae77fc4972248b38eb63ea25e5068fb/720p/mp4/file.mp4"
          style="width: 100%; height: 100%; display: block; object-fit: cover"
          muted
          playsinline
          loop
          autoplay
        ></video>
        <div
          id="unmuteTip"
          style="
            color: #fff;
            background: #111a;
            position: absolute;
            bottom: 6px;
            left: 8px;
            font-size: 1em;
            border-radius: 4px;
            padding: 2px 10px;
            display: none;
            z-index: 10;
            pointer-events: none;
          "
        >
          üîä Click to unmute
        </div>
      </div>
      <style>
        #ygPreview {
          position: fixed;
          width: 560px;
          height: 390px;
          display: none;
          z-index: 9999;
          border: 1px solid #ccc;
          border-radius: 6px;
          background: #000;
          box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
          overflow: hidden;
        }
      </style>
      </div>

    <div id="phPreview">
      <video
        id="phDemo"
        src="https://video.wixstatic.com/video/0d5d6f_e100780f16524e51bd9c8e49f1c8c71c/480p/mp4/file.mp4"
        style="
          width: 100%;
          height: 100%;
          display: block;
          object-fit: contain;
          background: #000;
        "
        muted
        playsinline
        loop
        preload="metadata"
      >
        <track
          kind="subtitles"
          src="/assets/phoneme-demo.vtt"
          srclang="en"
          label="English"
          default
        />
      </video>
      <div
        id="phUnmuteTip"
        style="
          color: #fff;
          background: #111a;
          position: absolute;
          bottom: 6px;
          left: 8px;
          font-size: 1em;
          border-radius: 4px;
          padding: 2px 10px;
          display: none;
          z-index: 10;
          pointer-events: none;
        "
      >
        üîä Click to toggle audio
      </div>
    </div>
    <div id="tts-controls" data-luxHidden="1"></div>

    <script>
      (function ensureCornerOverrides() {
        const ID = "lux-tts-corner-override";
        if (document.getElementById(ID)) return;
        const s = document.createElement("style");
        s.id = ID;
        s.textContent = `
          .lux-tts-panel{
            inset: env(safe-area-inset-top,0) env(safe-area-inset-right,0) auto auto !important;
            left:auto !important; bottom:auto !important;
            height:auto !important; min-height:0 !important;
            max-height:min(520px,70vh) !important;
            display:inline-block !important; overflow:visible !important;
            width:360px; max-width:min(92vw,380px);
          }
          .lux-tts-panel #tts-controls{
            height:auto !important; min-height:0 !important;
            max-height:none !important; overflow:visible !important;
          }
          .lux-tts-panel #tts-controls > *{ position:static !important; }
        `;
        document.head.appendChild(s);
        console.log("[tts] corner override injected");
      })();
    </script>

    <script type="module">
      (function () {
        const GUARD_ID = "lux-tts-guard-style";
        const CSS_CANDIDATES = ["./features/features/tts-peekaboo.css"];

        function ensureCSS() {
          const has = [...document.styleSheets].some((s) =>
            (s.href || "").includes("tts-peekaboo.css")
          );
          if (has) return;
          CSS_CANDIDATES.forEach((href) => {
            const link = document.createElement("link");
            link.rel = "stylesheet";
            link.href = href;
            link.addEventListener("error", () => link.remove(), { once: true });
            document.head.appendChild(link);
          });
        }

        function ensurePanel() {
          const host = document.getElementById("tts-controls");
          if (!host) return false;
          let panel = document.querySelector(".lux-tts-panel");
          if (!panel) {
            panel = document.createElement("aside");
            panel.className = "lux-tts-panel";
            panel.innerHTML = `<button class="lux-tts-tab" aria-expanded="false" aria-controls="tts-controls">Text-to-Speech</button>`;
            document.body.appendChild(panel);
            const tab = panel.querySelector(".lux-tts-tab");
            tab.addEventListener("click", () => {
              const willOpen =
                !document.documentElement.classList.contains("lux-tts-open");
              document.documentElement.classList.toggle(
                "lux-tts-open",
                willOpen
              );
              tab.setAttribute("aria-expanded", String(willOpen));
            });
          }
          if (!panel.contains(host)) panel.appendChild(host);

          document.getElementById(GUARD_ID)?.remove();
          host.dataset.luxHidden = "0";
          if (!host.firstElementChild) {
            const ph = document.createElement("div");
            ph.className = "lux-tts-loading";
            ph.textContent = "Loading Text-to-Speech‚Ä¶";
            host.appendChild(ph);
          }
          window.__ttsHost = host;

          window.luxTTS = Object.assign(window.luxTTS || {}, {
            nudge() {
              const tab = document.querySelector(".lux-tts-tab");
              if (!tab) return;
              tab.classList.remove("lux-tts-nudge");
              void tab.offsetWidth;
              tab.classList.add("lux-tts-nudge");
              setTimeout(() => tab.classList.remove("lux-tts-nudge"), 1400);
            },
          });

          console.info("[peekaboo] inline boot active");
          return true;
        }

        async function lateMount() {
          if (!ensurePanel()) return setTimeout(lateMount, 120);
          try {
            const mod = await import("./features/features/tts/player-ui.js");
            const host =
              window.__ttsHost || document.getElementById("tts-controls");
            if (mod?.mountTTSPlayer) mod.mountTTSPlayer(host);
            console.info("[tts] mounted after peekaboo boot");
          } catch (e) {
            console.warn("[tts] late import failed", e);
          }
        }

        function boot() {
          ensureCSS();
          lateMount();
        }
        if (document.readyState === "loading")
          document.addEventListener("DOMContentLoaded", boot);
        else boot();
      })();
    </script>

    <script type="module" src="./app-core/index.js"></script>
    
    <script type="module">
      // STATIC IMPORT FIX: Using direct import so Vite detects it correctly
      import { mountSelfPlaybackLite } from "./features/features/selfpb/ui.js";

      // Mount the Self Playback UI immediately
      mountSelfPlaybackLite();

      // Hydration logic to sync audio waveform with the <audio> element
      const audioEl = document.getElementById("playbackAudio");
      async function hydrate() {
        if (!audioEl) return;
        const srcFromChild = audioEl.querySelector("source")?.src || "";
        const url = audioEl.currentSrc || audioEl.src || srcFromChild;
        if (!url) return;
        try {
          const res = await fetch(url, { cache: "no-store" });
          const arr = await res.arrayBuffer();
          if (window.LuxSelfPB?.setLearnerArrayBuffer)
            await window.LuxSelfPB.setLearnerArrayBuffer(arr);
        } catch (e) {
          console.warn("[self-pb] could not fetch audio for panel", e);
        }
      }
      audioEl?.addEventListener("loadeddata", hydrate);
      if (audioEl?.src) hydrate();
    </script>

    <script
      type="module"
      src="./features/features/08-selfpb-peekaboo.js"
    ></script>

    <script>
      window.typeWriter = window.typeWriter || function () {};
    </script>
    <style id="sp-debug-show">
      .lux-sp-panel,
      #selfpb-lite {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
    </style>
  </body>
</html>