<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lux Pronunciation Tool</title>

    <link rel="stylesheet" href="base.css" />
    <link rel="stylesheet" href="features-1.css" />
    <link rel="stylesheet" href="features-2.css" />
    <link rel="stylesheet" href="lux-popover.css" />
    <link rel="stylesheet" href="lux-onboarding.css" />
    <link rel="stylesheet" href="lux-main.css" />

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="./features/features/tts.css" />
    <link rel="stylesheet" href="./features/features/tts-peekaboo.css" />
    <link rel="stylesheet" href="./features/features/tts/tts-overlay.css" />

    <link rel="stylesheet" href="./features/features/self-playback.css" />
    <link rel="stylesheet" href="./features/features/selfpb-peekaboo.css" />

    <style id="lux-tts-guard-style">
      #tts-controls { display: none !important; }
    </style>

    <script type="importmap">
      {
        "imports": {
          "ai.js": "./api/ai.js",
          "./api.js": "./api/index.js"
        }
      }
    </script>

    <script src="lux-popover.js" defer></script>
  </head>
  <body>
    <div id="container">
      <h2>Pronunciation Test</h2>

      <div id="userMsg">
        <ol>
          <li>We use and measure for standard American accents. Hear what it should sound like:</li>
          <li>The more recordings you make, the better the feedback will be ü§î üí≠ üí° üòÆ:
            <span class="lux-cta" tabindex="0" aria-haspopup="dialog" aria-expanded="false">
              database tracking
              <span class="lux-pop" role="dialog" aria-label="Database tracking details">
                <strong style="display: block; margin-bottom: 6px">How tracking helps</strong>
                <p style="margin: 0 0 8px; color: #444; font-size: 13px">
                  We save summaries of your practice so feedback improves over time.
                </p>
                <div class="lux-uidrow">
                  <span>Your UID:</span>
                  <code id="lux-uid">‚Ä¶</code>
                  <button id="lux-copy" class="lux-btn" type="button">Copy</button>
                  <small id="lux-copied" class="lux-copied" aria-live="polite"></small>
                </div>
                <div class="lux-links">
                  <a id="lux-link-attempts" target="_blank" rel="noopener">Attempts (admin)</a>
                  <a id="lux-link-progress" target="_blank" rel="noopener">User Progress (admin)</a>
                  <a id="lux-link-cohort" target="_blank" rel="noopener">Cohort (admin)</a>
                </div>
                <small class="lux-note">Admin token required for those pages.</small>
              </span>
            </span>.
          </li>
          <li>Remember‚Äîmistakes are a necessary part of learning! :)</li>
        </ol>
      </div>

      <label>
        Select Passage:
        <select id="passageSelect">
          <option value="" disabled selected>Select Passage...</option>
          
          <option value="rainbow">Rainbow Passage</option>
          <option value="grandfather">Grandfather Passage</option>
          <option value="minLR">Phoneme Test: L vs R</option>
          <option value="minEEIH">Phoneme Test: EE vs IH</option>
          <option value="minAUAH">Phoneme Test: A vs U</option>
          <option value="wordList">Challenging Word List</option>
          <option value="sentences">Challenging Sentences</option>
          <option value="shortStory">Short Story Practice</option>
          
          <option disabled>-------------------</option>
          <option value="write-own">Write Your Own...</option>
          <option value="clear" style="color:red;">Clear Text / Reset</option>
        </select>
        
        <span id="partsInfoTip" class="tooltip hidden" style="margin-left: 10px; cursor: pointer">
          (?)
          <span class="tooltiptext" style="font-size: 1em">
            These texts are designed to cover most sounds in English. Practicing them helps reveal your pronunciation strengths and weaknesses.
          </span>
        </span>
      </label>

      <label style="display: block; margin-top: 14px">
        First language:
        <select id="l1Select" name="l1Select">
          <option value="universal" selected>Universal (English-only)</option>
          <option value="ar">Arabic ‚Äì ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="zh">Chinese ‚Äì ‰∏≠Êñá</option>
          <option value="fr">French ‚Äì Fran√ßais</option>
          <option value="de">German ‚Äì Deutsch</option>
          <option value="hi">Hindi ‚Äì ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
          <option value="ja">Japanese ‚Äì Êó•Êú¨Ë™û</option>
          <option value="ko">Korean ‚Äì ÌïúÍµ≠Ïñ¥</option>
          <option value="mr">Marathi ‚Äì ‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
          <option value="pt">Portuguese ‚Äì Portugu√™s</option>
          <option value="ru">Russian ‚Äì –†—É—Å—Å–∫–∏–π</option>
          <option value="es">Spanish ‚Äì Espa√±ol</option>
        </select>
      </label>

      <span id="suggestedSentence" style="display: none"></span>
      <label style="margin-top: 20px">
        <span id="typewriterMsg" style="display: block; margin-bottom: 0.7em"></span>
        <textarea id="referenceText" placeholder="Paste or type everything you‚Äôll read here." rows="3"></textarea>
      </label>

      <div id="ghostControls">
        <button id="nextPartBtn">Next Part</button>
        <span id="nextPartMsg"></span>
        <button id="showSummaryBtn">Show Summary</button>
        <span id="passageLabel"></span>
        <span id="partProgress"></span>
      </div>

      <div class="btn-group">
        <button id="record">Record</button>
        <button id="stop" disabled>Stop</button>
      </div>

      <button id="playbackBtn" style="display: none">‚ñ∂ Play</button>
      <audio id="playbackAudio" hidden></audio>

      <p id="status">Not recording</p>
      <div id="prettyResult"></div>
      <div id="aiFeedbackSection"><div id="aiFeedback"></div></div>

      <button id="showMoreBtn" style="display: none; margin: 1em auto; padding: 0.7em 1.3em; font-size: 1em;">
        Show More
      </button>

      <div>
        <span class="show-raw-link" id="toggleRaw">Show Raw Data</span>
        <pre id="rawData" class="raw-data-section"></pre>
      </div>

      <div id="ygPreview">
        <video id="ygDemo" src="https://video.wixstatic.com/video/0d5d6f_5ae77fc4972248b38eb63ea25e5068fb/720p/mp4/file.mp4"
          style="width: 100%; height: 100%; display: block; object-fit: cover" muted playsinline loop autoplay></video>
        <div id="unmuteTip" style="color:#fff;background:#111a;position:absolute;bottom:6px;left:8px;font-size:1em;border-radius:4px;padding:2px 10px;display:none;z-index:10;pointer-events:none;">
          üîä Click to unmute
        </div>
      </div>

      <div id="phPreview">
        <video id="phDemo" src="https://video.wixstatic.com/video/0d5d6f_e100780f16524e51bd9c8e49f1c8c71c/480p/mp4/file.mp4"
          style="width: 100%; height: 100%; display: block; object-fit: contain; background: #000;" muted playsinline loop preload="metadata">
          <track kind="subtitles" src="/assets/phoneme-demo.vtt" srclang="en" label="English" default />
        </video>
        <div id="phUnmuteTip" style="color:#fff;background:#111a;position:absolute;bottom:6px;left:8px;font-size:1em;border-radius:4px;padding:2px 10px;display:none;z-index:10;pointer-events:none;">
          üîä Click to toggle audio
        </div>
      </div>
    </div>

    <div id="tts-controls" data-luxHidden="1"></div>

    <script type="module">
      import { 
        wirePassageSelect, 
        wireNextBtn
      } from './features/passages/index.js';

      import { 
        initLuxRecorder, 
        wireRecordingButtons 
      } from './features/recorder/index.js';

      import { 
        showSummary 
      } from './features/results/index.js';

      // --- VISUALS: Typewriter Effect (Updated & Speeded Up) ---
      let typewriterTimeout; // To track and kill the animation

      function startTypewriter() {
        const input = document.getElementById('referenceText');
        if (!input) return;

        // The "Near Infinite" list of suggestions
        const phrases = [
          "Paste or type everything you‚Äôll read here...",
          "Try the Rainbow Passage to test all phonemes...",
          "Focus on difficult words you struggle with...",
          "Select a passage from the menu above...",
          "Practice your elevator pitch...",
          "Rehearse your upcoming presentation script...",
          "Read an email draft out loud to check the tone...",
          "Prepare for a job interview answer...",
          "Practice your Zoom meeting introduction...",
          "Read your favorite poem aloud...",
          "Practice a movie monologue...",
          "Try a difficult tongue twister...",
          "Read a recipe instruction clearly...",
          "Tell a short story...",
          "Practice ordering coffee clearly...",
          "Read a news headline...",
          "Practice explaining a complex idea simple...",
          "Work on your 'R' and 'L' sounds...",
          "Slow down and enunciate every syllable..."
        ];
        
        let i = 0;
        let charIndex = 0;
        let isDeleting = false;
        let currentPhrase = "";

        function type() {
          // If user clicked or typed, STOP completely.
          if (document.activeElement === input || input.value.length > 0) return;

          const fullPhrase = phrases[i];

          if (isDeleting) {
            currentPhrase = fullPhrase.substring(0, charIndex - 1);
            charIndex--;
          } else {
            currentPhrase = fullPhrase.substring(0, charIndex + 1);
            charIndex++;
          }

          input.setAttribute('placeholder', currentPhrase);

          // --- SPEED SETTINGS (Faster) ---
          let speed = 40; // Fast typing
          if (isDeleting) speed = 20; // Super fast deleting

          if (!isDeleting && charIndex === fullPhrase.length) {
            speed = 2000; // Pause at end of sentence
            isDeleting = true;
          } else if (isDeleting && charIndex === 0) {
            isDeleting = false;
            i = (i + 1) % phrases.length;
            speed = 500; // Pause briefly before next sentence
          }

          typewriterTimeout = setTimeout(type, speed);
        }
        
        type();
      }

      // --- MAIN BOOT SEQUENCE ---
      async function bootApp() {
        console.log("[Lux] Booting features...");

        // 1. Setup Passages (Standard)
        wirePassageSelect();     
        wireNextBtn();           

        // 2. Setup "Write Your Own" and "Clear" Handling
        const passageSelect = document.getElementById('passageSelect');
        const textInput = document.getElementById('referenceText');
        
        passageSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            
            // Handle Custom Menu Options
            if (val === 'write-own') {
                textInput.value = "";
                textInput.focus(); // This triggers the focus event below
            } 
            else if (val === 'clear') {
                textInput.value = "";
                passageSelect.value = ""; // Reset dropdown to "Select Passage"
                textInput.blur(); // Remove focus so animation can restart
                startTypewriter(); // Restart animation
            }
            // Note: Standard passages are handled by wirePassageSelect()
        });

        // 3. Stop animation on click/focus
        textInput.addEventListener('focus', () => {
            clearTimeout(typewriterTimeout);
            // Change placeholder to the "Ready" state
            textInput.setAttribute('placeholder', "Type whatever you like here...");
        });
        
        // 4. Restart animation if they leave it empty
        textInput.addEventListener('blur', () => {
            if (textInput.value.trim() === "") {
                startTypewriter();
            }
        });

        // 5. Setup Recorder
        await initLuxRecorder(); 
        wireRecordingButtons();

        // 6. Setup Summary Button
        const summaryBtn = document.getElementById('showSummaryBtn');
        if (summaryBtn) {
          summaryBtn.addEventListener('click', showSummary);
        }

        // 7. Start the visuals
        startTypewriter();
        
        console.log("[Lux] App fully initialized.");
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bootApp);
      } else {
        bootApp();
      }
    </script>

    <script type="module">
      import { bootTTS } from './features/features/tts/boot-tts.js';
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bootTTS);
      } else {
        bootTTS();
      }
    </script>

    <script type="module">
      import { mountSelfPlaybackLite } from "./features/features/selfpb/ui.js";
      mountSelfPlaybackLite();

      const audioEl = document.getElementById("playbackAudio");
      async function hydrate() {
        if (!audioEl) return;
        const srcFromChild = audioEl.querySelector("source")?.src || "";
        const url = audioEl.currentSrc || audioEl.src || srcFromChild;
        if (!url) return;
        try {
          const res = await fetch(url, { cache: "no-store" });
          const arr = await res.arrayBuffer();
          if (window.LuxSelfPB?.setLearnerArrayBuffer)
            await window.LuxSelfPB.setLearnerArrayBuffer(arr);
        } catch (e) {
          console.warn("[self-pb] could not fetch audio for panel", e);
        }
      }
      audioEl?.addEventListener("loadeddata", hydrate);
      if (audioEl?.src) hydrate();
    </script>

    <script type="module" src="./features/features/08-selfpb-peekaboo.js"></script>

    <script>
      // Fallback in case old typewriter calls still exist
      window.typeWriter = window.typeWriter || function () {};
    </script>
  </body>
</html>